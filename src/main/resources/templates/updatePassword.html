<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity5" layout:decorate="~{layout}">

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
	<style>
		.password-verdict {
			color: #000;
		}
	</style>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
	<script th:src="@{/resources/pwstrength.js}"></script>
	<title th:utext="#{message.updatePassword}">update password</title>
</head>

<body class="d-flex flex-column h-100">
	<div layout:fragment="content">
		<div class="row d-flex justify-content-center align-items-center h-100">
			<div class="col-12 col-md-8 col-lg-6 col-xl-5">
				<div class="card shadow-2-strong" style="border-radius: 1rem; margin: 1.1em;">
					<div class="card-body p-5 text-center">
						<h3 th:utext="#{message.resetYourPassword}">reset</h3>
						<form>

							<div class="form-floating mb-3">
								<input name="newPassword" type="password" class="form-control" id="newPassword" value=""
									required placeholder="newPassword">
								<label for="newPassword" th:utext="#{label.user.newPassword}">New password</label>
							</div>



							<div class="form-floating mb-3">
								<input name="matchPassword" type="password" class="form-control" id="matchPassword"
									value="" required placeholder="confirm password">
								<label for="matchPassword" th:utext="#{label.user.confirmPass}">confirm
									password</label>
							</div>

							<div class="form-floating mb-3">
								<input class="form-control" name="token" id="token" readonly th:value="${param.token}"
									required>
								<label for="token" th:utext="#{token.message}">
									token</label>
							</div>
							<div id="globalError" class="col-sm-12 alert alert-danger" style="display:none"
								th:utext="#{PasswordMatches.user}">error</div>

							<div class="col-sm-12">
								<br /><br />
								<button class="btn btn-primary" type="submit" onclick="savePass()"
									th:utext="#{message.updatePassword}">submit</button>
							</div>
						</form>

					</div>
				</div>
			</div>
		</div>

		<script th:inline="javascript">
			var serverContext = [[@{/}]];

			$(document).ready(function () {
				$('form').submit(function (event) {
					savePass(event);
				});

				$(":password").keyup(function () {
					if ($("#newPassword").val() != $("#matchPassword").val()) {
						$("#globalError").show().html(/*[[#{PasswordMatches.user}]]*/);
					} else {
						$("#globalError").html("").hide();
					}
				});

				options = {
					common: {minChar: 8},
					ui: {
						showVerdictsInsideProgressBar: true,
						showErrors: true,
						errorMessages: {
							wordLength: /*[[#{error.wordLength}]]*/,
							wordNotEmail: /*[[#{error.wordNotEmail}]]*/,
							wordSequences: /*[[#{error.wordSequences}]]*/,
							wordLowercase: /*[[#{error.wordLowercase}]]*/,
							wordUppercase: /*[[#{error.wordUppercase}]]*/,
							wordOneNumber: /*[[#{error.wordOneNumber}]]*/,
							wordOneSpecialChar: /*[[#{error.wordOneSpecialChar}]]*/
                    }
					}
				};
				$('#newPassword').pwstrength(options);
			});

			function savePass(event) {
				event.preventDefault();
				$(".alert").html("").hide();
				$(".error-list").html("");
				if ($("#newPassword").val() != $("#matchPassword").val()) {
					$("#globalError").show().html(/*[[#{PasswordMatches.user}]]*/);
					return;
				}
				var formData = $('form').serialize();
				$.post(serverContext + "user/savePassword", formData, function (data) {
					window.location.href = serverContext + "login?message=" + data.message;
				})
					.fail(function (data) {
						if (data.responseJSON.error.indexOf("InternalError") > -1) {
							window.location.href = serverContext + "login?message=" + data.responseJSON.message;
						}
						else {
							var errors = $.parseJSON(data.responseJSON.message);
							$.each(errors, function (index, item) {
								$("#globalError").show().html(item.defaultMessage);
							});
							errors = $.parseJSON(data.responseJSON.error);
							$.each(errors, function (index, item) {
								$("#globalError").show().append(item.defaultMessage + "<br/>");
							});
						}
					});
			}

		</script>
	</div>
</body>

</html>