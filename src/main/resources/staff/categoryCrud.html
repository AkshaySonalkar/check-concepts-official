<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity5" layout:decorate="~{layout}">

<head>
	<title>Category</title>
</head>

<body class="d-flex flex-column h-100">
	<div layout:fragment="content">
		<div th:if="${message != null}" class="alert alert-info" th:utext="${message}">message</div>
		<div id="message" th:if="${message == null}" style="display: none;" class="alert alert-info"></div>
		<div th:if="${error != null}" class="alert alert-danger" th:utext="${session[SPRING_SECURITY_LAST_EXCEPTION]}">
			error</div>
		<span id="categoryError" class="alert alert-danger" style="display:none"></span>
		<div class="container-fluid">
			<section>
				<div class="card mb-4">
					<div class="card-header">
						<i class="fas fa-table me-1"></i>
						Categories
					</div>
					<div class="card-body">
						<table class="table table-striped table-bordered" id="categoryTable" style="width: 100%;">
							<thead>
								<tr>
									<th scope="col" style="width: 20%;">Category Name</th>
									<th scope="col" style="width: 40%;">Description</th>
									<th scope="col" style="width: 10%;">Premium</th>
									<th scope="col" style="width: 10%;">Tech</th>
									<th scope="col" style="width: 10%;">Edit</th>
									<th scope="col" style="width: 10%;">Delete</th>
								</tr>
							</thead>
							<tbody>
								<tr th:each="category : ${categories}">
									<td th:text="${category.name}"></td>
									<td th:text="${category.description}" style="word-break: break-word !important;">
									</td>
									<td th:text="${category.premium}"></td>
									<td th:text="${category.tech}"></td>
									<td><a th:href="@{/staff/category/edit/{id}(id=${category.id})}"
											class="btn btn-primary"><i class="fa-solid fa-pen-to-square"></i></a></td>
									<td><a th:href="@{/staff/category/delete/{id}(id=${category.id})}"
											class="btn btn-primary"><i class="fa-solid fa-trash-can"></i>
									</td>

								</tr>
							</tbody>
						</table>
					</div>
				</div>
				<div class="card mb-4">
					<div class="card-header">
						<i class="fa-solid fa-file-circle-plus me-1"></i>
						Add New Category
					</div>
					<div class="card-body">
						<div class="container py-5 h-100">

							<form action="/" method="POST" enctype="utf8">
								<div class="mb-3">
									<label for="name" class="form-label">Category Name</label>
									<input type="text" class="form-control" name="name" id="name" required
										maxlength="50">
								</div>
								<div class="mb-3">
									<label for="description" class="form-label">Category Description</label>
									<textarea type="text" id="description" name="description" required maxlength="200"
										class="form-control md-textarea"></textarea>
								</div>
								<div class="mb-3 form-check">
									<input type="checkbox" class="form-check-input" id="tech" name="tech">
									<label class="form-check-label" for="tech">is Tech category?</label>
								</div>
								<div class="mb-3 form-check">
									<input type="checkbox" class="form-check-input" id="premium" name="premium">
									<label class="form-check-label" for="premium">is premium?</label>
								</div>
								<button type="submit" class="btn btn-primary">Submit</button>
							</form>
						</div>
					</div>
				</div>
			</section>
		</div>

		<script th:inline="javascript">
			var serverContext = [[@{/}]];

			$(document).ready(function () {
				$('form').submit(function (event) {
					createCategory(event);
				});
			});

			function createCategory(event) {
				event.preventDefault();
				var formData = $('form').serialize();
				$.post(serverContext + "staff/category/save", formData, function (data) {
					if (data.message == "success") {
						window.location.href = serverContext + "staff/categoryCrud?message=New Category Added Successfully";
					}

				})
					.fail(function (data) {
						if (data.responseJSON.error == "CategoryAlreadyExist") {
							$("#categoryError").show().html(data.responseJSON.message);
						}
						else if (data.responseJSON.error.indexOf("InternalError") > -1) {
							window.location.href = serverContext + "staff/categoryCrud?message=" + data.responseJSON.message;
						}

					});
			}
		</script>

		<script type="text/javascript">
			$(document).ready(function () {

				$('#categoryTable').dataTable({
					scrollY: 200,
					scrollX: true,
				});

			});

			window.onload = function () {
				displayMessage();
			};

			function displayMessage() {

				const queryString = window.location.search;
				const urlParams = new URLSearchParams(queryString);
				const message = urlParams.get('message');

				const div = document.getElementById('message');
				if (div.style.display === "none" && message != null) {
					div.style.display = "block";
					div.textContent = message;
				}
			}

		</script>
	</div>
</body>

</html>